# Телеграмм бот для прохождения теста "Колесо компетенций" от Geekrains

В этом проекте будет рассмотрен процесс запуска бота при помощи Docker compose. Поэтому акцент будет сконцентрирован на Dockerfile и docker-compose.

## Папка appBotPython

В этой папке написан бот, взаимодействие его с базой данных и Dockerfile для создания образа.

В файле **button.py** написаны методы создания кнопок.

В файле **create_5_spec.py** написан метод для создания пяти портретов специалистов (разработчика, тестировщика, аналитика, проджект-менеджера и продакт-менеджера).

В файле **data_frame.py** описаны методы для получения данных из БД и произведено подключение к БД.

В файле **img.py** 3 метода, которые создают портрет пользователя после прохождения теста, графики сравнения портрета пользователя с портретами специалистов и итоговою иллюстрацию с проходными балами.

В файле **sqlyghter.py** описаны метод инициализации подключения к БД и методы, которые позволют вызывать запросы в БД.

В файле **text.py** собрана информация для пользователя и для корректной работы бота.

Файл **main.py** является точкой входа. В нём создан бот и его логика.

## Dockerfile:

В этой папке он собрёт образ приложения из которого будет разварачиваться контейнер.

- строка 1 - говорит, что образ будет собран на основе python:3.11.1

```.
   FROM python:3.11.1
```

- строка 3 - рабочая директория в образе

```.
   WORKDIR /home
```

- в строках 4 - 9 создаются глобальные переменные, которые будут использоваться в образе и, впоследствии, в запущенном контейнере

```.
   ENV API_TOKEN="token_your_bot"

   ENV HOST="sqlForDB" (название должно совпадать с названием службы для контенера sql - смотри ниже)

   ENV PORT="3306"

   ENV USER="root"

   ENV PASSWORD="your_password"

   ENV DB_NAME="botgb"
```

- строка 11, 12 - нужны для залания времени и логирования

```.
   ENV TZ=Europe/Moscow

   RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
```

- В строках 13 - 19 прописаны команды для установки необходимых библиотек в контейнер и создания папок

```.
   RUN pip install --force-reinstall -v "aiogram==2.23.1" && \

    pip install pymysql && \

    pip install numpy && \

    pip install matplotlib && \

    pip install cryptography && \

    mkdir log && \

    mkdir result_img

```

- Строка 20 - копируем все файлы с раширением "py". То есть копируется программа в образ.

```.
   COPY *.py ./
```

Для создания образа необходимо находять в этой папке написать команду **docker build -t tgbot .**

## Папка mysql:

В этой папке находится ещё одна папка **cod** с файлом **sql**, который нужен для создания БД и вайл Dockerfile для создания образа из которого будет разварачиваться контенер БД.

## Dockerfile

- указывается версия образа на основе которого будет создан наш образ.

```.
   FROM mysql:8.0
```

- следующий код означает, что папка cod, которая лежит в одной дирректории с этим Dockerfile, будет скопирована в /docker-entrypoint-initdb.d/ внуртри контейнера и все sql файлы лежащие в этой папке будут запущены при развёртывании контейнера. Важный момент. Необходимо иметь точку монтирования для базы данных. Для того, что бы не терялись данные когла база рухнет и заново перезапустится. И при первом запуске эта точка монтирования должна быть пуста. Потомучто /docker-entrypoint-initdb.d/ проверяет эту точку монтирования и если она пуста, то выполняется код внутри /docker-entrypoint-initdb.d/ А если точка монтированя уже имеет файлы базы данных, то есть база уже создана и наработала некую базу, то это всё подтянется из точки монтирования, а /docker-entrypoint-initdb.d/ проигнарирует скрипт внутри себя.

```.
   COPY ./code/ /docker-entrypoint-initdb.d/
```

И для создания образа необходимо дать команду **docker build -t tgsql .**

## Файл docker-compose.yml

Сервис **tg:**

- образ из которого разворачивается контейнер

```.
   image: tgbot
```

- задаётся имя контейнера

```.
   container_name: tg
```

- политика запуска/перезапуска контейнера в случае обрушения

```.
   restart: always
```

- команда, которая будет выполняться при запуске контейнера. Этот контейнер будет зависить от контейнера с БД. И запускаться сразу после того, как контейнер с бд запустится, но мы дадим ещё 10 секунд на то, что бы БД прогрузилась до конца и после этого запустится контенер с приложением

```.
   command: sh -c "sleep 10s ; python3 ./main.py"
```

- создаются точки монтирования. Для логирования и для хранения изображений. Это необходимо для того, что бы данные не утратились в случае обрушения контенера.

```.
   volumes:
      - ./log:/home/log
      - ./res_img:/home/result_img
```

- указывается, что разворачивается одна версия контейнера

```.
   deploy:
      mode: replicated
      replicas: 1
```

- указывается, что этот контейнер запустится только после запуска контейнера с БД

```.
   depends_on:
      - sqlForDB
```

- указывается сеть внутри контейнера, в которой будет работать данное приложение.

```.
   networks:
      - app-network
```

Сервис **sqlForDB:**

- устанавливаются переменные и указывается какая БД будет использоваться и пароль

```.
   environment:
      MYSQL_DATABASE: 'botgb'
      MYSQL_ROOT_PASSWORD: 'your_password'
```

- задаются порты, через которые можно будет подключиться к БД. 3308 - порт на хостовой машине(сервере), 3306 - стандартный порт для БД MYSQL внутри коонтейнера.

```.
   ports:
      - '3308:3306'
```

- так же устанавливается точка монтирования для БД. Именно её будет проверять образ при разворачивании контейнера. Если эта точка будет пуста, то контейнер запустится с запуска файла внутри себя для создания БД. Если эта точка будет уже заполнена, то при запуске контейнера вся БД подтянется из этой точки монтирования.

```.
   volumes:
      - ./lib:/var/lib/mysql
```

**Создание сети:**

- Нужно создать общую сеть между контейнерами, что бы они могли видеть друг друга и обащться

```.
   networks:
      app-network:
        driver: bridge
```

Перед запуском файла docker-compose.yml проверте, что бы были созданы образы для приложения и БД:

- **docker images**

И запустите его. **docker compose up**
